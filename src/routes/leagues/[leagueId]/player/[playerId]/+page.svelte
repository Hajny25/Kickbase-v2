<script lang="ts">
	import Event from '$lib/Event.svelte';
	import { onDestroy } from 'svelte';

	export let data: PlayerLoadData;
	let playerData = data.player_data;
	let events = data.player_live.e;
	let currentAdress: string = '0';

	$: totalPoints = events.reduce((sum: number, elem: EventData) => sum + elem.p, 0);
	const positions = ['Torwart', 'Abwehr', 'Mittelfeld', 'Angriff'];

	setTimeout(() => {
		fetchUpdates();
	}, 0);

	let visible = true;
	onDestroy(() => (visible = false));

	async function fetchUpdates() {
		if (visible) {
			console.log(`F${data.playerId}`, currentAdress);
			const r = await fetch(
				`https://pubsub-1.pubnub.com/subscribe/${data.pub.sub}/${data.pub.scn}/0/${currentAdress}`
			);
			const json: PubUpdateData = await r.json();
			const update = json[0];
			if (update) {
				handleUpdate(update);
			}
			currentAdress = json[1];
			setTimeout(() => {
				fetchUpdates();
			}, 0);
		} else {
			console.log(`S${data.playerId}`);
		}
	}

	function handleUpdate(update: { it: EventData[] }[]) {
		update.forEach((block) => {
			if (!block.hasOwnProperty('it')) return;
			block['it'].forEach((element: EventData) => {
				if (data.playerId == element['pid']) {
					events = [element, ...events];
				}
			});
		});
	}
</script>

<div class="flex flex-col items-center max-w-[500px] p-5 mx-auto">
	<div class="flex flex-col items-center bg-surface-500 shadow-md shadow-black rounded-md p-3 px-4">
		<p class="font-semibold text-lg text-gray-300">{playerData.firstName}</p>
		<p class="font-bold text-gray-200 text-xl">{playerData.lastName}</p>
		<p>{positions[playerData.position - 1]}</p>
		<img src={playerData.profileBig} alt="Player" width="165" class="object-cover h-full" />
		<div class="grid grid-cols-3 grid-rows-2 w-full place-items-center mt-3">
			<svg
				class="row-start-1 col-start-1 fill-gray-500"
				height="20px"
				viewBox="0 0 512 512"
				version="1.1"
				xmlns="http://www.w3.org/2000/svg"
				xmlns:xlink="http://www.w3.org/1999/xlink"
			>
				<g id="Page-1" stroke="3" stroke-width="1" fill-rule="evenodd">
					<g id="drop" transform="translate(60.496777, 60.491376)">
						<path
							d="M362.038672,4.40536496e-13 L392.208561,30.1698893 L330.849151,91.530257 C352.999344,120.319635 366.169889,156.376056 366.169889,195.508624 C366.169889,289.765221 289.75982,366.17529 195.503223,366.17529 C156.370421,366.17529 120.313802,353.004587 91.5243389,330.854154 L30.1698893,392.208561 L-1.42108547e-14,362.038672 L61.2047929,300.834525 C38.4229489,271.826458 24.836556,235.254177 24.836556,195.508624 C24.836556,101.252026 101.246625,24.841957 195.503223,24.841957 C235.248317,24.841957 271.820213,38.4280364 300.82812,61.2094052 L362.038672,4.40536496e-13 Z M300.334816,122.043508 L122.038107,300.340217 C142.831803,314.939228 168.166768,323.508624 195.503223,323.508624 C266.195671,323.508624 323.503223,266.201072 323.503223,195.508624 C323.503223,168.172169 314.933827,142.837204 300.334816,122.043508 Z M195.503223,67.5086237 C124.810775,67.5086237 67.5032227,124.816176 67.5032227,195.508624 C67.5032227,223.460895 76.4630581,249.320485 91.66741,270.372075 L270.365674,91.6720892 C249.314266,76.4681756 223.455052,67.5086237 195.503223,67.5086237 Z"
							id="Combined-Shape"
						>
						</path>
					</g>
				</g>
			</svg>
			<p class="text-center row-start-2 col-start-1">{playerData.averagePoints}</p>
			<svg
				class="row-start-1 col-start-2 fill-gray-500"
				xmlns="http://www.w3.org/2000/svg"
				viewBox="0 0 512 512"
				version="1.1"
				height="20"
			>
				<path
					d="M0 0 C1.43424374 -0.00505263 2.86848115 -0.01228697 4.30270422 -0.02149814 C8.22122668 -0.0403455 12.13912107 -0.02822977 16.0576272 -0.01077521 C20.29216897 0.00263599 24.5266211 -0.01285159 28.76115417 -0.02459717 C37.04706654 -0.04294925 45.33274265 -0.03447815 53.61864759 -0.01650894 C60.35319751 -0.0024692 67.0876834 0.0014069 73.82224655 -0.00195122 C74.78163222 -0.00242866 75.74101789 -0.0029061 76.72947585 -0.00339801 C78.67857367 -0.00442436 80.62767148 -0.00547972 82.57676928 -0.00656378 C99.80028068 -0.01512568 117.02367818 0.00152863 134.24716187 0.03126526 C150.95456729 0.06011041 167.66180868 0.06718128 184.36923218 0.05177307 C202.57197534 0.03500877 220.77464068 0.03097835 238.97738588 0.04848343 C240.91860285 0.05032779 242.85981984 0.05216251 244.80103683 0.0539875 C245.75610752 0.05489959 246.71117821 0.05581168 247.69519044 0.05675141 C254.42169128 0.06235469 261.14815409 0.05905166 267.87465286 0.05244255 C276.07178803 0.04470803 284.26876178 0.05146651 292.46586443 0.07661759 C296.64715577 0.08910884 300.82819586 0.09526368 305.00949669 0.08407593 C308.83884529 0.07402336 312.6676932 0.08251437 316.49698095 0.10565711 C317.88038688 0.11080945 319.2638378 0.10926703 320.64722402 0.10026246 C329.58507347 0.04693559 335.8069295 0.60215611 342.88485718 6.45240784 C343.41466187 7.06729065 343.94446655 7.68217346 344.49032593 8.31568909 C345.03302124 8.91768127 345.57571655 9.51967346 346.13485718 10.13990784 C351.82402957 19.31459851 351.11845911 29.31045876 351.07626343 39.69068909 C351.07828782 41.44988627 351.0812023 43.20908264 351.08496094 44.96827698 C351.08936709 48.6430821 351.08300861 52.31766746 351.06893921 55.9924469 C351.05184833 60.68287657 351.06169872 65.37279109 351.0796566 70.0632019 C351.09054082 73.6922335 351.08702691 77.32114466 351.07927322 80.95018005 C351.07728402 82.67879804 351.0796851 84.40742726 351.08671188 86.1360321 C351.14609811 104.84773545 351.14609811 104.84773545 345.99032593 113.44068909 C340.69458633 118.45017249 336.05145971 119.89946969 328.74032593 120.12818909 C322.528697 119.93573477 317.96857966 118.84910703 312.67782593 115.62818909 C312.04231812 115.26596252 311.4068103 114.90373596 310.75204468 114.53053284 C302.7987932 109.5065303 299.97133481 101.54458698 297.70516968 92.80006409 C297.45537857 91.88863647 297.20558746 90.97720886 296.94822693 90.03816223 C295.88992691 86.17555034 294.86202671 82.30502755 293.83187866 78.43482971 C293.07132466 75.59517452 292.29496398 72.76017415 291.51766968 69.92506409 C291.17843727 68.61562836 291.17843727 68.61562836 290.83235168 67.27973938 C290.60854324 66.46499146 290.3847348 65.65024353 290.15414429 64.81080627 C289.96492905 64.09769287 289.77571381 63.38457947 289.58076477 62.64985657 C288.36433698 59.9262917 286.9857987 58.52777743 284.67782593 56.62818909 C281.74400114 55.92967104 281.74400114 55.92967104 278.45263672 55.88825989 C277.20241352 55.83298378 275.95219032 55.77770767 274.66408157 55.72075653 C267.86823129 55.56294566 261.07815621 55.47175269 254.28085327 55.46705627 C252.68923837 55.46241427 251.09762455 55.45738782 249.50601196 55.45201111 C245.22984967 55.43903701 240.95370293 55.43247451 236.67752409 55.42800045 C234.00228516 55.42505143 231.32705034 55.42094385 228.65181351 55.41649628 C220.26905859 55.40287467 211.88631323 55.39317629 203.50354803 55.38929439 C193.84568066 55.38479566 184.18795354 55.36714199 174.53012884 55.33829379 C167.04279427 55.31670664 159.55549932 55.30659206 152.06813395 55.30525327 C147.60355806 55.30420516 143.139115 55.29829325 138.67457199 55.28043365 C134.48670476 55.26399944 130.29907109 55.26177461 126.11118317 55.27057266 C124.57446544 55.27134494 123.03773533 55.26697523 121.50104904 55.25711441 C119.4053464 55.24445233 117.31047897 55.25023884 115.21478271 55.26069641 C114.04200964 55.25922985 112.86923656 55.25776329 111.66092491 55.25625229 C108.3766408 55.66574125 107.01671007 56.3296619 104.67782593 58.62818909 C103.39395399 61.7950732 103.48245231 63.15683316 104.79501343 66.32350159 C107.07279202 70.32142834 109.7894332 73.67525917 112.74032593 77.19068909 C113.92132985 78.62059241 115.10100423 80.05159483 116.27938843 81.48365784 C116.85978882 82.18796936 117.44018921 82.89228088 118.03817749 83.61793518 C121.56093457 87.93693188 124.91018912 92.38880405 128.29110718 96.81910706 C131.04772415 100.41532744 133.83267502 103.98960057 136.61532593 107.56568909 C137.51299683 108.71931946 137.51299683 108.71931946 138.42880249 109.89625549 C143.38431313 116.25973477 148.36182015 122.60567416 153.35116577 128.94264221 C155.62868799 131.83627736 157.903066 134.73238232 160.17782593 137.62818909 C161.09447823 138.79486704 162.01114488 139.96153372 162.92782593 141.12818909 C164.76115926 143.46152242 166.59449259 145.79485575 168.42782593 148.12818909 C168.88133423 148.70536682 169.33484253 149.28254456 169.80209351 149.87721252 C170.72125905 151.04708924 171.64036688 152.21701132 172.55941772 153.38697815 C174.81238686 156.25490065 177.06626316 159.12209899 179.32235718 161.98756409 C185.0628899 169.28141743 190.77571348 176.59625105 196.4637146 183.9311676 C199.24682409 187.51713408 202.03983488 191.09341777 204.87313843 194.63990784 C205.36942749 195.26316956 205.86571655 195.88643127 206.37704468 196.52857971 C207.28964758 197.67245869 208.20597513 198.81338213 209.12704468 199.95045471 C215.09906948 207.44824761 219.08974836 214.75435808 218.67782593 224.50318909 C217.05735619 236.09307047 207.87753103 244.03238779 200.14901733 252.08033752 C197.79739383 254.55449834 195.57266275 257.13170311 193.34188843 259.71412659 C189.0855027 264.60996932 184.69744145 269.39170209 180.34970093 274.20631409 C176.36078016 278.6294031 172.40214686 283.07433913 168.49032593 287.56568909 C165.64634798 290.80193986 162.75169892 293.99227577 159.86532593 297.19068909 C157.95228444 299.32236389 156.05894981 301.46838019 154.17782593 303.62818909 C150.785295 307.52331719 147.32588392 311.35601671 143.86532593 315.19068909 C141.95228444 317.32236389 140.05894981 319.46838019 138.17782593 321.62818909 C134.785295 325.52331719 131.32588392 329.35601671 127.86532593 333.19068909 C125.95228444 335.32236389 124.05894981 337.46838019 122.17782593 339.62818909 C119.54092957 342.65573676 116.86766024 345.64756188 114.17782593 348.62818909 C111.35237927 351.76274444 108.5327819 354.90167972 105.74032593 358.06568909 C105.19505249 358.68315002 104.64977905 359.30061096 104.08798218 359.93678284 C101.92944313 362.52583383 100.72683905 364.16746572 100.36532593 367.56568909 C100.71152259 370.95841639 101.29122079 372.24158395 103.67782593 374.62818909 C107.19674577 375.80116237 109.97109149 375.76005414 113.68658447 375.76863098 C114.76319546 375.77308766 114.76319546 375.77308766 115.86155617 375.77763438 C118.27281798 375.78632396 120.68403016 375.78782984 123.0953064 375.7893219 C124.82160549 375.79394985 126.54790356 375.79897448 128.27420044 375.80436707 C132.96842329 375.81749428 137.66263184 375.82393651 142.35687017 375.82837772 C145.28851483 375.83130759 148.22015556 375.83541221 151.15179825 375.8398819 C160.32108062 375.85355693 169.49035405 375.86322387 178.65964592 375.86708379 C189.25035698 375.87156638 199.84093909 375.88912361 210.43161094 375.91808438 C218.61427478 375.93968507 226.7969023 375.94978719 234.97959435 375.95112491 C239.8685763 375.95217398 244.75743703 375.95810369 249.64638901 375.97594452 C254.24449514 375.9923976 258.84238857 375.99459419 263.44051361 375.98580551 C265.12838179 375.98503368 266.81626128 375.989397 268.5041008 375.99926376 C270.80802173 376.01194252 273.11118469 376.00612918 275.4151001 375.99568176 C276.7044792 375.99714832 277.9938583 375.99861488 279.32230949 376.00012589 C282.94657847 375.59839965 284.80848185 374.84040005 287.67782593 372.62818909 C289.44528318 369.70283583 289.44528318 369.70283583 290.79891968 366.23756409 C291.19978539 365.30330597 291.19978539 365.30330597 291.60874939 364.35017395 C292.45922716 362.36546213 293.28920127 360.3731486 294.11532593 358.37818909 C302.62918633 337.90587201 302.62918633 337.90587201 311.86532593 333.75318909 C312.70450562 333.36389221 313.5436853 332.97459534 314.40829468 332.57350159 C318.85712996 330.72045832 322.73188484 330.41270181 327.49032593 330.37818909 C328.53930054 330.34725159 328.53930054 330.34725159 329.60946655 330.31568909 C335.86299568 330.26888999 339.72741869 331.90457339 344.36532593 336.00318909 C350.05681667 342.46380019 350.82566054 347.89922462 350.83895874 356.3049469 C350.84392365 357.06175247 350.84888855 357.81855804 350.85400391 358.59829712 C350.86856294 361.0926455 350.87541748 363.58693026 350.88095093 366.08131409 C350.88670806 367.82380676 350.89246571 369.56629944 350.89822388 371.30879211 C350.90871644 374.96034539 350.91457034 378.61187677 350.9180603 382.26344299 C350.92353768 386.92479185 350.94755687 391.58584754 350.97603226 396.24710464 C350.99472835 399.84694748 350.99986796 403.44672071 351.00139618 407.04660797 C351.00440812 408.76407725 351.01238696 410.48154574 351.02558136 412.19896698 C351.17769609 433.5226324 351.17769609 433.5226324 344.49032593 440.94068909 C343.96052124 441.5555719 343.43071655 442.17045471 342.88485718 442.80397034 C335.22021585 449.13916945 328.10798359 449.20662991 318.53369141 449.14958191 C317.09435052 449.15562855 315.65501605 449.16340934 314.21569288 449.17276704 C310.27381303 449.19329872 306.33229755 449.18897097 302.39038801 449.18040586 C298.13395247 449.17546616 293.87760407 449.1935061 289.62120056 449.20848083 C281.28760189 449.2339646 272.95413213 449.23756353 264.62050106 449.23288031 C257.84587705 449.22931254 251.07129215 449.23281629 244.29667282 449.24132919 C242.84972793 449.24311476 242.84972793 449.24311476 241.37355184 449.2449364 C239.41382842 449.24735993 237.454105 449.2497882 235.49438159 449.25222115 C217.12076337 449.27396827 198.74721859 449.26964899 180.37359624 449.25745146 C163.57103237 449.24711331 146.76870042 449.26962402 129.96618243 449.3076479 C112.7060495 449.3464074 95.44602628 449.36291625 78.18584955 449.3554014 C68.49848256 449.35157771 58.81131294 449.35654884 49.12398148 449.38483047 C40.87704182 449.40866365 32.63042105 449.41146207 24.38347699 449.38725014 C20.17752178 449.37547614 15.97214973 449.37326207 11.76623344 449.39725494 C7.91184211 449.41898662 4.05852028 449.41275304 0.20417885 449.38473158 C-1.18605979 449.37944114 -2.57638244 449.38416053 -3.96653859 449.4002033 C-12.90443282 449.49614588 -19.29062224 448.40462802 -26.32217407 442.62818909 C-31.24227352 437.39953689 -32.99422163 431.96237223 -33.69717407 424.81568909 C-33.18440955 413.13357559 -25.49473598 405.71468533 -18.04922485 397.54078674 C-15.39329512 394.59951539 -12.82732106 391.58394961 -10.25967407 388.56568909 C-9.26911022 387.40786182 -8.27822493 386.25030947 -7.28701782 385.09303284 C-6.55394409 384.23620911 -6.55394409 384.23620911 -5.80606079 383.36207581 C-3.31321883 380.44924863 -0.81754641 377.53884848 1.67782593 374.62818909 C2.67783933 373.46153391 3.67783933 372.29486724 4.67782593 371.12818909 C14.67782593 359.46152242 24.67782593 347.79485575 34.67782593 336.12818909 C35.17274536 335.55076965 35.66766479 334.97335022 36.17758179 334.37843323 C37.17834198 333.21090681 38.17915585 332.04342639 39.18002319 330.87599182 C41.66883269 327.9728528 44.15672683 325.06893959 46.64266968 322.16334534 C52.34510423 315.50050075 58.07168282 308.85947203 63.81991577 302.23609924 C68.96944342 296.29930431 74.08482827 290.33365453 79.19393921 284.36207581 C81.68678117 281.44924863 84.18245359 278.53884848 86.67782593 275.62818909 C87.67783933 274.46153391 88.67783933 273.29486724 89.67782593 272.12818909 C95.67782593 265.12818908 95.67782593 265.12818908 97.17807007 263.37794495 C98.17730989 262.21213804 99.17649616 261.04628523 100.17562866 259.88038635 C102.68682054 256.95018511 105.19895986 254.02080617 107.71298218 251.09303284 C110.70496818 247.60791519 113.69273372 244.11921267 116.67782593 240.62818909 C117.19892944 240.01926819 117.72003296 239.41034729 118.25692749 238.78297424 C119.79539559 236.98335521 121.33082119 235.181188 122.86532593 233.37818909 C123.5702417 232.5543573 123.5702417 232.5543573 124.28939819 231.71388245 C127.98489809 227.36091368 129.23950646 224.79877681 129.13095093 219.10865784 C128.24308928 214.24838074 124.94445896 211.16338759 121.67782593 207.62818909 C120.71409387 206.56976867 119.75056468 205.51116349 118.78720093 204.45240784 C116.71551333 202.1887695 114.62952797 199.93941607 112.53329468 197.69850159 C109.74932772 194.71768849 107.05357157 191.66950096 104.38485718 188.58522034 C102.34149162 186.24259758 100.26101734 183.93545486 98.17782593 181.62818909 C94.91391745 178.01142563 91.68991644 174.364293 88.49032593 170.69068909 C86.40571428 168.3185448 84.29353949 165.97262844 82.17782593 163.62818909 C78.91391745 160.01142563 75.68991644 156.364293 72.49032593 152.69068909 C70.40571428 150.3185448 68.29353949 147.97262844 66.17782593 145.62818909 C62.91391745 142.01142563 59.68991644 138.364293 56.49032593 134.69068909 C54.40571428 132.3185448 52.29353949 129.97262844 50.17782593 127.62818909 C46.91391745 124.01142563 43.68991644 120.364293 40.49032593 116.69068909 C38.40571428 114.3185448 36.29353949 111.97262844 34.17782593 109.62818909 C30.91391745 106.01142563 27.68991644 102.364293 24.49032593 98.69068909 C22.40571428 96.3185448 20.29353949 93.97262844 18.17782593 91.62818909 C15.48799162 88.64756188 12.81472229 85.65573676 10.17782593 82.62818909 C6.06701554 77.91117625 1.87114747 73.2718002 -2.32217407 68.62818909 C-13.24364004 56.53394825 -13.24364004 56.53394825 -18.32217407 50.62818909 C-19.58481079 49.16639221 -19.58481079 49.16639221 -20.87295532 47.67506409 C-21.77338305 46.61835841 -22.6731242 45.5610673 -23.57217407 44.50318909 C-24.40233032 43.53123596 -25.23248657 42.55928284 -26.08779907 41.55787659 C-31.09488615 34.99264003 -33.14677839 28.85923945 -32.32217407 20.62818909 C-30.78337995 14.26703227 -27.78106446 8.07671288 -22.35132277 4.23303753 C-14.92125634 0.15312358 -8.35780601 -0.07519208 0 0 Z "
					transform="translate(97.32217407226563,31.371810913085938)"
				/>
			</svg>
			<p class="text-center row-start-2 col-start-2">{playerData.totalPoints}</p>
			<svg
				class="row-start-1 col-start-3 fill-gray-500"
				height="20px"
				version="1.1"
				id="Capa_1"
				xmlns="http://www.w3.org/2000/svg"
				xmlns:xlink="http://www.w3.org/1999/xlink"
				viewBox="0 0 481.569 481.569"
				xml:space="preserve"
			>
				<g>
					<path
						d="M444.288,429.288c-5.4-13.2-10.9-26.4-16.9-39.4c-5.3-11.6-12.1-15-24.8-12.1c-16.1,3.7-31.9,8.6-48,11.9
		c-31.1,6.5-62.3,7.1-93-2.6c-38.5-12.1-59-40-71.6-76h104.4c8.2,0,14.8-6.6,14.8-14.8v-32.9c0-8.2-6.6-14.8-14.8-14.8h-114.4
		c0-9.2-0.1-18,0-26.8h114.4c8.2,0,14.8-6.6,14.8-14.8v-32.9c0-8.2-6.6-14.8-14.8-14.8h-100c0-0.4,0-0.8,0.2-1
		c12-27.3,29.5-49.2,58.2-60.6c33.4-13.2,67.5-12.9,101.9-5.8c16.3,3.3,32.3,8.3,48.6,12c11.9,2.7,18.8-0.8,23.9-11.9
		c5.9-12.8,11.3-25.8,16.7-38.9c5.1-12.3,2.1-21-9.5-27.8c-2.9-1.7-5.9-3.1-9-4.3c-48.2-18.8-97.9-25.8-149.2-17.6
		c-36.1,5.8-69.8,18.2-98.9,40.8c-36.7,28.4-60.5,65.9-74.3,110l-1.7,5.1h-51.4c-8.2,0-14.8,6.6-14.8,14.8v32.9
		c0,8.2,6.6,14.8,14.8,14.8h40.5c0,9,0,17.7,0,26.8h-40.5c-8.2,0-14.8,6.6-14.8,14.8v32.9c0,8.2,6.6,14.8,14.8,14.8h48.8
		c3.7,12,6.8,24.2,11.5,35.7c24.7,59.6,66.1,102,128.4,122.2c51.5,16.7,103.4,16.2,155.3,1.9c13.5-3.7,26.9-8.5,39.7-14.4
		C445.988,450.788,449.188,441.188,444.288,429.288z"
					/>
				</g>
			</svg>
			<p class="text-center row-start-2 col-start-3">
				{playerData.marketValue.toLocaleString('de-DE')}
			</p>
		</div>
	</div>
	{#if events.length == 0}
		<p class="text-gray-300">No events</p>
	{:else}
		<p class="my-3"><span class="font-bold">Total: </span>{totalPoints}</p>
		{#each events as event (event.i)}
			<Event {event} />
		{/each}
	{/if}
</div>
